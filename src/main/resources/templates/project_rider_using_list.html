<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/project_footer.css">
    <link rel="stylesheet" href="/css/project_header.css">
    <link rel="stylesheet" href="/css/project_rider.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=4jevlbxAGy2TQzNvpdD2B3eAfmkUdXQr8uWsi1A1"></script>
    <script>
        window.addEventListener('load', function(){
                        var fullAddressElements = document.querySelectorAll('#delivery_address');

                        // 값을 담을 빈 배열을 생성합니다.
                        var addresses = [];

                        // 각 요소의 값을 배열에 추가합니다.
                        fullAddressElements.forEach(function(element) {
                            addresses.push(element.value);
                        });
                        console.log(addresses);

                        var headers = {};
                        headers["appKey"]="4jevlbxAGy2TQzNvpdD2B3eAfmkUdXQr8uWsi1A1";

                    var endX = '';
                    var endY = '';

                addresses.forEach(function(fullAddr, index) {
                        $.ajax({
                            method: "GET",
                            headers: headers,
                            url: "https://apis.openapi.sk.com/tmap/geo/fullAddrGeo?version=1&format=json",
                            async: false,
                            data: {
                                "coordType": "WGS84GEO",
                                "fullAddr": fullAddr
                            },
                            success: function(response) {
                                var resultInfo = response.coordinateInfo;
                                console.log(resultInfo);
                                console.log(resultInfo.coordinate);
                                console.log("주소: " + fullAddr);
                                console.log("위도: " + resultInfo.coordinate[0].newLatEntr);
                                console.log("경도: " + resultInfo.coordinate[0].newLonEntr);

                                endX = resultInfo.coordinate[0].newLonEntr;
                                endY = resultInfo.coordinate[0].newLatEntr;

                                distance(endY, endX, index);
                            },
                            error: function(xhr, status, error) {
                                console.error(error);
                            }
                        });
                    });
            console.log(endX);
            console.log(endY);
        });



        function distance(endY, endX, index){
            navigator.geolocation.getCurrentPosition((position) => {

                    console.log(position.coords.latitude);
                    console.log(position.coords.longitude);
                    var searchOption = "2";

                    var trafficInfochk = "N";

                    var headers = {};
                    headers["appKey"]="4jevlbxAGy2TQzNvpdD2B3eAfmkUdXQr8uWsi1A1";

                    $.ajax({
                    type : "POST",
                    headers : headers,
                    url : "https://apis.openapi.sk.com/tmap/routes?version=1&format=json&callback=result&appKey=4jevlbxAGy2TQzNvpdD2B3eAfmkUdXQr8uWsi1A1",
                    async : false,
                    data : {
                         "startX" : position.coords.longitude,
                         "startY" : position.coords.latitude,
                         "endX" : endX,
                         "endY" : endY,
                         "reqCoordType" : "WGS84GEO",
                         "resCoordType" : "EPSG3857",
                         "searchOption" : searchOption,
                         "trafficInfo" : trafficInfochk
                    },
                    success : function(response) {

                     var resultData = response.features;

                     var tDistance = (resultData[0].properties.totalDistance / 1000)
                                 .toFixed(1) + "km";
                    console.log(tDistance);
                    $('.delivery_dis').eq(index).html(tDistance);

                     var tTime = " 총 시간 : "
                           + (resultData[0].properties.totalTime / 60)
                                 .toFixed(0) + "분";
                    }
                });
            });
        }
    </script>
    <title>Document</title>
</head>
<header th:replace="~{/common/project_header :: header}"></header>
<body>
    <div class='container'>
<!--        <aside th:replace="~{/common/project_rider_header :: rider_header}"></aside>-->
        <div class='rider_header'>
            <div class='ride_head'>배달</div><br>
            <div class='ride_txt'>
                <div>진행중인 배달 건수 : </div>
<!--                <div class='ride_num' th:text="${cnt}">0건</div>-->
                <div class='ride_num' th:text="${cnt[0]['RESULT']} + '건'">0건</div>
            </div>
        </div>
        <div class='select_category'>
            <ul>
                <a href="/ride/wait"><li th:text="${'대기중(' + cnt[1]['RESULT']} + ')'">대기중(0)</li></a>
                <a href="/ride/accept"><li class='active' th:text="${'진행중(' + cnt[0]['RESULT']} + ')'">진행중(16)</li></a>
                <a href="/ride/finish"><li th:text="${'완료(' + cnt[2]['RESULT']} + ')'">완료(7)</li></a>
            </ul>
        </div>
            <div class='delivery_list'>
                <ul>
                    <th:block th:each="list : ${orderList}">
                        <a th:href="@{/ride/orders/{ordersId}(ordersId=${list.ordersId})}" >
                            <li>
                                <span class='order_num'>주문번호 :&nbsp;</span><span class='order_num' name="ordersId" th:text="${list.ordersId}">1119</span><br>
                                <span class='delivery_address' th:text="${list.ordersAddress + ' ' + list.ordersAddressDetails}">서울특별시 서대문구 대현동 777-8 508동 116호</span>
                                <div class='space'>
<!--                                    <span class='delivery_time' th:text="${list.ordersPayStatus == 3 or ordersPayStatus == 11 ? '수거전' : (ordersPayStatus == 4 or ordersPayStatus == 12 ? '수거완료' : '수거전')}">수거전</span>-->
                                    <span class='delivery_time' th:text="${list.ordersPayStatus == 3 ? '수거전' : '수거완료'}">수거전</span>
                                    <span class='delivery_dis'>거리 : 1.2km</span>
                                </div>
                            </li>
                            <input type="hidden" name="" id="delivery_address" value="" th:value="${list.ordersAddress}">
                        </a>
                    </th:block>
                    <th:block th:if="${cnt[0]['RESULT'] == 0}">
                        <li class='drive_none'>
                            <span>현재 진행 중인 배달이 없습니다!</span>
                        </li>
                    </th:block>
                </ul>
            </div>
    </div>
</body>
<footer th:replace="~{/common/project_footer :: footer}"> </footer>
</html>