<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/project_footer.css">
    <link rel="stylesheet" href="/css/project_header.css">
    <link rel="stylesheet" href="/css/project_rider.css">
    <!-- sock js -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
    <!-- STOMP -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
        window.addEventListener('load', function() {

            // 주문 완료 메세지 받기
            const socket = new SockJS('/websocket');
            const stompClient = Stomp.over(socket);
            stompClient.connect({}, function() {

            const storeId = '63';
            stompClient.subscribe('/topic/order-complete/'+storeId, function(message) {

            const messageBody = JSON.parse(message.body);

            const orders = messageBody.a;
            const orderId = orders.ordersId;
<!--  ------------------------------------------------------------------------------------------ -->

            <!-- 배달 지역 -->
            const address = orders.ordersAddress;
            console.log(address);
            var parts = address.split(" ")[1];
            console.log(parts);

            <!-- 라이더 희망지역 -->
            const riderArea = $("#workingArea").val();

            var headers = {};
            headers["appKey"]="4jevlbxAGy2TQzNvpdD2B3eAfmkUdXQr8uWsi1A1";

            var endX = '';
            var endY = '';

            if(riderArea === parts){
            $.ajax({
            method: "GET",
            headers: headers,
            url: "https://apis.openapi.sk.com/tmap/geo/fullAddrGeo?version=1&format=json",
            async: false,
            data: {
                "coordType": "WGS84GEO",
                "fullAddr": address
            },
            success: function(response) {
                var resultInfo = response.coordinateInfo;
                console.log(resultInfo);
                console.log("위도: " + resultInfo.coordinate[0].newLatEntr);
                console.log("경도: " + resultInfo.coordinate[0].newLonEntr);

                console.log(resultInfo.coordinate[0].lon);
                console.log(resultInfo.coordinate[0].lat);

                console.log(resultInfo.coordinate[0].adminDong);

                    if (resultInfo.coordinate[0].adminDong === "" || resultInfo.coordinate[0].adminDong === null) {
                        endX = resultInfo.coordinate[0].newLonEntr;
                        endY = resultInfo.coordinate[0].newLatEntr;
<!--                        distance(endY, endX);-->
                    }else {
                        endX = resultInfo.coordinate[0].lon;
                        endY = resultInfo.coordinate[0].lat;
<!--                        distance(endY, endX);-->
                    }
            },
            error: function(xhr, status, error) {
                console.error(error);
            }
        });
        console.log(endY);
        console.log(endX);

        navigator.geolocation.getCurrentPosition((position) => {

                    console.log(position.coords.latitude);
                    console.log(position.coords.longitude);
                    var searchOption = "12";

                    var trafficInfochk = "N";

                    var headers = {};
                    headers["appKey"]="4jevlbxAGy2TQzNvpdD2B3eAfmkUdXQr8uWsi1A1";

                    $.ajax({
                    type : "POST",
                    headers : headers,
                    url : "https://apis.openapi.sk.com/tmap/routes?version=1&format=json&callback=result&appKey=4jevlbxAGy2TQzNvpdD2B3eAfmkUdXQr8uWsi1A1",
                    async : false,
                    data : {
                         "startX" : position.coords.longitude,
                         "startY" : position.coords.latitude,
                         "endX" : endX,
                         "endY" : endY,
                         "reqCoordType" : "WGS84GEO",
                         "resCoordType" : "EPSG3857",
                         "searchOption" : searchOption,
                         "trafficInfo" : trafficInfochk
                    },
                    success : function(response) {

                     var resultData = response.features;

                     var tDistance = "거리 : " + (resultData[0].properties.totalDistance / 1000)
                                 .toFixed(1) + "km";
                    console.log(tDistance);
                    $('.delivery_dis').eq(0).html(tDistance);

                     var tTime = " 총 시간 : "
                           + (resultData[0].properties.totalTime / 60)
                                 .toFixed(0) + "분";
                    }
                });
            });
        }



<!--  ------------------------------------------------------------------------------------------ -->

            $(".drive_none").hide();

            var listItem = '' ;

            if(orders == null){
            listItem =`
                    <li class='drive_none'>
                        <span>현재 배달 요청이 없습니다!</span>
                    </li>`;
            }else if(riderArea === parts){
                var count = parseInt($(".ride_num").text(), 10);
                count++;
                $(".ride_num").text(count + "건");

                listItem = `
                    <a href='/ride/orders/25'>
                        <li>
                            <span class='order_num'>주문번호 :&nbsp;</span><span class='order_num' name="ordersId" >1119</span><br>
                            <span class='delivery_address'>${orders.ordersAddress} ${orders.ordersAddressDetails}</span>
                            <div class='space'>
                                <span class='delivery_time'>${orders.ordersDate}</span>
                                <span class='delivery_dis'>100km</span>
                            </div>
                        </li>
                    </a>`;
                }
                $("#orderList").prepend(listItem);
                });
            });
        });


        function distance(endY, endX){
            navigator.geolocation.getCurrentPosition((position) => {

                    console.log(position.coords.latitude);
                    console.log(position.coords.longitude);
                    var searchOption = "12";

                    var trafficInfochk = "N";

                    var headers = {};
                    headers["appKey"]="4jevlbxAGy2TQzNvpdD2B3eAfmkUdXQr8uWsi1A1";

                    $.ajax({
                    type : "POST",
                    headers : headers,
                    url : "https://apis.openapi.sk.com/tmap/routes?version=1&format=json&callback=result&appKey=4jevlbxAGy2TQzNvpdD2B3eAfmkUdXQr8uWsi1A1",
                    async : false,
                    data : {
                         "startX" : position.coords.longitude,
                         "startY" : position.coords.latitude,
                         "endX" : endX,
                         "endY" : endY,
                         "reqCoordType" : "WGS84GEO",
                         "resCoordType" : "EPSG3857",
                         "searchOption" : searchOption,
                         "trafficInfo" : trafficInfochk
                    },
                    success : function(response) {

                     var resultData = response.features;

                     var tDistance = "거리 : " + (resultData[0].properties.totalDistance / 1000)
                                 .toFixed(1) + "km";
                    console.log(tDistance);
                    $('.delivery_dis').eq(0).html(tDistance);

                     var tTime = " 총 시간 : "
                           + (resultData[0].properties.totalTime / 60)
                                 .toFixed(0) + "분";
                    }
                });
            });
        }

    </script>
    <title>Document</title>
</head>
<header th:replace="~{/common/project_header :: header}"></header>
<body>
    <div class='container'>
<!--        <aside th:replace="~{/common/project_rider_header :: rider_header}"></aside>-->
            <div class='rider_header'>
                <div class='ride_head'>배달</div><br>
                <div class='ride_txt'>
                    <div class='ch'>대기중인 배달 건수 : </div>
                    <div class='ride_num' th:text="${cnt[1]['RESULT']} + '건'">0건</div>
                </div>
            </div>
            <div class='select_category'>
                <ul>
                    <a href="/ride/wait"><li class='active' th:text="${'대기중(' + cnt[1]['RESULT']} + ')'">대기중(0)</li></a>
                    <a href="/ride/accept"><li th:text="${'진행중(' + cnt[0]['RESULT']} + ')'">진행중(16)</li></a>
                    <a href="/ride/finish"><li th:text="${'완료(' + cnt[2]['RESULT']} + ')'">완료(7)</li></a>
                </ul>
            </div>
            <div class='delivery_list'>
                <ul id="orderList">
                    <th:block th:each="list : ${orderList}">
                    <a th:href="@{/ride/orders/{ordersId}(ordersId=${list.ordersId})}">
                        <li>
                            <span class='order_num'>주문번호 :&nbsp;</span><span class='order_num' name="ordersId" th:text="${list.ordersId}">1119</span><br>
                            <span class='delivery_address' th:text="${list.ordersAddress + ' ' + list.ordersAddressDetails}">서울특별시 서대문구 대현동 777-8 508동 116호</span>
                            <div class='space'>
                                <span class='delivery_time' th:text="${list.ordersDate}">2023-08-26 18:57:11</span>
                                <span class='delivery_dis'>거리 : 1.2km</span>
                            </div>
                        </li>
                    </a>
                    </th:block>
                    <th:block th:if="${cnt[1]['RESULT'] == 0}">
                        <li class='drive_none'>
                            <span>현재 요청된 배달이 없습니다.</span>
                        </li>
                    </th:block>
                </ul>
            </div>
        <div id="orderStatus"></div>
        <input type="hidden" name="workingArea" id="workingArea" value="" th:value="${riderInfo.workingArea}">
    </div>
</body>
<footer th:replace="~{/common/project_footer :: footer}"> </footer>
</html>