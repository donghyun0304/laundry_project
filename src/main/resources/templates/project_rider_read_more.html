<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/project_footer.css">
    <link rel="stylesheet" href="/css/project_header.css">
    <link rel="stylesheet" href="/css/project_read_more.css">
    <link rel="stylesheet" href="/css/project_order_2_2.css">
    <script>
       function goToRiderList() {
            window.location.href = "riderList.html";
        }
    </script>

    <title>Document</title>
</head>
<header th:replace="~{/common/project_header :: header}"></header>
<body onload="initTmap();">
    <div class='container'>
        <form action="" method="get">

            <!-- 로그인 페이지 -> 배달기사 페이지 -->

            <!-- 완료 : 배송완료 사진 / 대기중 : 이동경로 표시 -->
            <div class='address_map' id="map_div">

            </div>
            <div class='agree_zone'>
<!--                <input type="submit" value="수락하기" id='agree_btn' style='display: none;'>-->
<!--                <input type="submit" value="배송완료" id='agree_btn'>-->

<!--                <br>-->
<!--                <div class='imglist'>-->
<!--                    <div class='imgbox'>-->
<!--                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width='2rem'>-->
<!--                            <path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>-->
<!--                        <span>사진</span>-->
<!--                    </div>-->
<!--                </div>-->
            <!-- 대기중 / 진행중 -->
            <div class='location'>
                <svg xmlns="http://www.w3.org/2000/svg" class='left' viewBox="0 0 384 512"><path d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class='right' viewBox="0 0 384 512"><path d="M215.7 499.2C267 435 384 279.4 384 192C384 86 298 0 192 0S0 86 0 192c0 87.4 117 243 168.3 307.2c12.3 15.3 35.1 15.3 47.4 0zM192 128a64 64 0 1 1 0 128 64 64 0 1 1 0-128z"/></svg>
            </div>
            <div class='progress '>
                <div class='icon'>
                    <p class='icon_text' id='distance'></p>
                    <p class='icon_text' id='time'></p>
                </div>
                <div class='line'></div>
            </div>
            </div>
            <!-- 파일첨부 공간 -->



            <div class='drive_information'>
                <p class="aa">주문번호</p>
                    <input type="text" name="" id="orderNum" value='qweqwe1591' readonly>
                <br>
                <p>주소</p>
                    <input type="text" name="" id="address" value='서울특별시 서대문구 대현동 777-8 508동 116호' readonly>
                <br>
                <p>수거시간</p>
                <input type="text" name="" id="pickUpTime" value='비밀번호 없음' readonly>
                <br>
                <p>요청시간</p>
                <input type="text" name="" id="requestTime" value='금일 오후 7시까지'>
                <br>
                <p>요청사항</p>
                <input type="text" name="" id="requestInfo" value='문앞에 두고 벨눌러 주세요.' readonly>
                <br>
                <p>수거위치</p>
                <input type="text" name="" id="pickUpRegion" value='문 앞' readonly>
                <br>
                <p>공동현관 비밀번호</p><input type="text" name="" id="doorPw" value='비밀번호 없음' readonly>
            </div>
        </form>
    </div>
</body>
<footer th:replace="~{/common/project_footer :: footer}"> </footer>
<script	src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=4jevlbxAGy2TQzNvpdD2B3eAfmkUdXQr8uWsi1A1"></script>
<script>

            var map;
			var markerInfo;
			var marker_s, marker_e, marker_p;
			var drawInfoArr = [];
			var drawInfoArr2 = [];

			var chktraffic = [];
			var resultdrawArr = [];
			var resultMarkerArr = [];
document.querySelector('.aa').innerHTML = '1';
			function initTmap() {
				map = new Tmapv2.Map("map_div", {
					center : new Tmapv2.LatLng(37.54882398563218, 126.99276886231617),
					width : "100%",
					height : "400px",
					zoom : 10,
					zoomControl : true,
					scrollwheel : true
				});
				document.querySelector('.aa').innerHTML = '2';
				alert(navigator == true)
				alert(navigator.geolocation == true)
				navigator.geolocation.getCurrentPosition((position) => {
				marker_s = new Tmapv2.Marker(
                    {
							position : new Tmapv2.LatLng(position.coords.latitude, position.coords.longitude),
							icon : "https://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_s.png",
							iconSize : new Tmapv2.Size(24, 38),
							map : map
						});
                    });

				marker_e = new Tmapv2.Marker(
						{
							position : new Tmapv2.LatLng(37.403049076341794,
									127.10331814639885),
							icon : "https://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_e.png",
							iconSize : new Tmapv2.Size(24, 38),
							map : map
						});

				$(document).ready(function(){
									navigator.geolocation.getCurrentPosition((position) => {

										console.log(position.coords.latitude);
										console.log(position.coords.longitude);

									resettingMap();

									var searchOption = "1";

									var trafficInfochk = "N";

									var headers = {};
										headers["appKey"]="4jevlbxAGy2TQzNvpdD2B3eAfmkUdXQr8uWsi1A1";

									$.ajax({
										type : "POST",
										headers : headers,
										url : "https://apis.openapi.sk.com/tmap/routes?version=1&format=json&callback=result&appKey=4jevlbxAGy2TQzNvpdD2B3eAfmkUdXQr8uWsi1A1",
										async : false,
										data : {
											"startX" : position.coords.longitude,
											"startY" : position.coords.latitude,
											"endX" : "127.10331814639885",
											"endY" : "37.403049076341794",
											"reqCoordType" : "WGS84GEO",
											"resCoordType" : "EPSG3857",
											"searchOption" : searchOption,
											"trafficInfo" : trafficInfochk
										},
										success : function(response) {

											var resultData = response.features;

											var tDistance = "총 거리 : "
													+ (resultData[0].properties.totalDistance / 1000)
															.toFixed(1) + "km";
                                            document.getElementById('distance').innerHTML = tDistance;

											var tTime = " 총 시간 : "
													+ (resultData[0].properties.totalTime / 60)
															.toFixed(0) + "분";
                                            document.getElementById('time').innerHTML = tTime;

											var tFare = " 총 요금 : "
													+ resultData[0].properties.totalFare
													+ "원,";
											var taxiFare = " 예상 택시 요금 : "
													+ resultData[0].properties.taxiFare
													+ "원";

											$("#result").text(
													tDistance + tTime + tFare
															+ taxiFare);

											if (trafficInfochk == "Y") {
												for ( var i in resultData) {
													var geometry = resultData[i].geometry;
													var properties = resultData[i].properties;

													if (geometry.type == "LineString") {
														chktraffic
																.push(geometry.traffic);
														var sectionInfos = [];
														var trafficArr = geometry.traffic;

														for ( var j in geometry.coordinates) {
															var latlng = new Tmapv2.Point(
																	geometry.coordinates[j][0],
																	geometry.coordinates[j][1]);
															var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(
																	latlng);

															sectionInfos
																	.push(convertPoint);
														}

														drawLine(sectionInfos,
																trafficArr);
													} else {

														var markerImg = "";
														var pType = "";

														if (properties.pointType == "S") {
															markerImg = "https://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_s.png";
															pType = "S";
														} else if (properties.pointType == "E") {
															markerImg = "https://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_e.png";
															pType = "E";
														} else {
															markerImg = "http://topopen.tmap.co.kr/imgs/point.png";
															pType = "P"
														}

														var latlon = new Tmapv2.Point(
																geometry.coordinates[0],
																geometry.coordinates[1]);
														var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(
																latlon);

														var routeInfoObj = {
															markerImage : markerImg,
															lng : convertPoint._lng,
															lat : convertPoint._lat,
															pointType : pType
														};
														addMarkers(routeInfoObj);
													}
												}

											} else {

												for ( var i in resultData) {
													var geometry = resultData[i].geometry;
													var properties = resultData[i].properties;

													if (geometry.type == "LineString") {
														for ( var j in geometry.coordinates) {

															var latlng = new Tmapv2.Point(
																	geometry.coordinates[j][0],
																	geometry.coordinates[j][1]);

															var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(
																	latlng);

															var convertChange = new Tmapv2.LatLng(
																	convertPoint._lat,
																	convertPoint._lng);

															drawInfoArr
																	.push(convertChange);
														}
														drawLine(drawInfoArr,
																"0");
													} else {

														var markerImg = "";
														var pType = "";

														if (properties.pointType == "S") {
															markerImg = "https://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_s.png";
															pType = "S";
														} else if (properties.pointType == "E") {
															markerImg = "https://tmapapi.sktelecom.com/upload/tmap/marker/pin_r_m_e.png";
															pType = "E";
														} else {
															markerImg = "http://topopen.tmap.co.kr/imgs/point.png";
															pType = "P"
														}


														var latlon = new Tmapv2.Point(
																geometry.coordinates[0],
																geometry.coordinates[1]);

														var convertPoint = new Tmapv2.Projection.convertEPSG3857ToWGS84GEO(
																latlon);

														var routeInfoObj = {
															markerImage : markerImg,
															lng : convertPoint._lng,
															lat : convertPoint._lat,
															pointType : pType
														};


														addMarkers(routeInfoObj);
													}
												}
											}
										},
										error : function(request, status, error) {
											console.log("code:"
													+ request.status + "\n"
													+ "message:"
													+ request.responseText
													+ "\n" + "error:" + error);
										}
									});
								});

						});
			}

			function addComma(num) {
				var regexp = /\B(?=(\d{3})+(?!\d))/g;
				return num.toString().replace(regexp, ',');
			}


			function addMarkers(infoObj) {
				var size = new Tmapv2.Size(24, 38);

				if (infoObj.pointType == "P") {
					size = new Tmapv2.Size(8, 8);
				}

				marker_p = new Tmapv2.Marker({
					position : new Tmapv2.LatLng(infoObj.lat, infoObj.lng),
					icon : infoObj.markerImage,
					iconSize : size,
					map : map
				});

				resultMarkerArr.push(marker_p);
			}


			function drawLine(arrPoint, traffic) {
				var polyline_;

				if (chktraffic.length != 0) {



					var lineColor = "";

					if (traffic != "0") {
						if (traffic.length == 0) {

							lineColor = "#06050D";

							polyline_ = new Tmapv2.Polyline({
								path : arrPoint,
								strokeColor : lineColor,
								strokeWeight : 6,
								map : map
							});
							resultdrawArr.push(polyline_);

						} else {

							if (traffic[0][0] != 0) {
								var trafficObject = "";
								var tInfo = [];

								for (var z = 0; z < traffic.length; z++) {
									trafficObject = {
										"startIndex" : traffic[z][0],
										"endIndex" : traffic[z][1],
										"trafficIndex" : traffic[z][2],
									};
									tInfo.push(trafficObject)
								}

								var noInfomationPoint = [];

								for (var p = 0; p < tInfo[0].startIndex; p++) {
									noInfomationPoint.push(arrPoint[p]);
								}


								polyline_ = new Tmapv2.Polyline({
									path : noInfomationPoint,
									strokeColor : "#06050D",
									strokeWeight : 6,
									map : map
								});

								resultdrawArr.push(polyline_);

								for (var x = 0; x < tInfo.length; x++) {
									var sectionPoint = [];

									for (var y = tInfo[x].startIndex; y <= tInfo[x].endIndex; y++) {
										sectionPoint.push(arrPoint[y]);
									}

									if (tInfo[x].trafficIndex == 0) {
										lineColor = "#06050D";
									} else if (tInfo[x].trafficIndex == 1) {
										lineColor = "#61AB25";
									} else if (tInfo[x].trafficIndex == 2) {
										lineColor = "#FFFF00";
									} else if (tInfo[x].trafficIndex == 3) {
										lineColor = "#E87506";
									} else if (tInfo[x].trafficIndex == 4) {
										lineColor = "#D61125";
									}


									polyline_ = new Tmapv2.Polyline({
										path : sectionPoint,
										strokeColor : lineColor,
										strokeWeight : 6,
										map : map
									});

									resultdrawArr.push(polyline_);
								}
							} else {

								var trafficObject = "";
								var tInfo = [];

								for (var z = 0; z < traffic.length; z++) {
									trafficObject = {
										"startIndex" : traffic[z][0],
										"endIndex" : traffic[z][1],
										"trafficIndex" : traffic[z][2],
									};
									tInfo.push(trafficObject)
								}

								for (var x = 0; x < tInfo.length; x++) {
									var sectionPoint = [];

									for (var y = tInfo[x].startIndex; y <= tInfo[x].endIndex; y++) {
										sectionPoint.push(arrPoint[y]);
									}

									if (tInfo[x].trafficIndex == 0) {
										lineColor = "#06050D";
									} else if (tInfo[x].trafficIndex == 1) {
										lineColor = "#61AB25";
									} else if (tInfo[x].trafficIndex == 2) {
										lineColor = "#FFFF00";
									} else if (tInfo[x].trafficIndex == 3) {
										lineColor = "#E87506";
									} else if (tInfo[x].trafficIndex == 4) {
										lineColor = "#D61125";
									}


									polyline_ = new Tmapv2.Polyline({
										path : sectionPoint,
										strokeColor : lineColor,
										strokeWeight : 6,
										map : map
									});

									resultdrawArr.push(polyline_);
								}
							}
						}
					} else {

					}
				} else {
					polyline_ = new Tmapv2.Polyline({
						path : arrPoint,
						strokeColor : "#DD0000",
						strokeWeight : 6,
						map : map
					});
					resultdrawArr.push(polyline_);
				}

			}


			function resettingMap() {

				marker_s.setMap(null);
				marker_e.setMap(null);

				if (resultMarkerArr.length > 0) {
					for (var i = 0; i < resultMarkerArr.length; i++) {
						resultMarkerArr[i].setMap(null);
					}
				}

				if (resultdrawArr.length > 0) {
					for (var i = 0; i < resultdrawArr.length; i++) {
						resultdrawArr[i].setMap(null);
					}
				}

				chktraffic = [];
				drawInfoArr = [];
				resultMarkerArr = [];
				resultdrawArr = [];
			}
    </script>
</html>